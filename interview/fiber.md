# React Fiber

## React 15  的问题

**在页面元素很多的情况的下，react15会出现的掉帧的情况**

**其根本原因是大量的同步任务阻塞的浏览器的UI渲染，在默认的情况下，js的运算，页面布局，页面绘制都是运行的在浏览器的主线程中的额，他们之间是互斥关系，如果js的运算持续占用主线程，页面就无法及时的获得更新**

> 争对这一方面react从框架层面对web运行的机制做了优化

## 如何解决

**将运算切割为多个步骤，分批完成，也就是说在完成一部分任务后，将控制权交给浏览器，让浏览器有时间去渲染页面，等浏览器忙完以后再继续之前的任务**

**旧版的react通过递归的方式进行渲染，使用的是js引擎自身呢个的函数调用栈，他会一直执行到栈为空，而fiber实现了自己的组件调用栈，他一链表的形式遍历组件树，可以灵活的暂停，继续和丢弃执行的任务，实现方法是使用的浏览器的requetIdleCallback这一API，官方这样解释：**

> window.requestIdleCallback会在浏览器空闲的时候依次调用函数，这就可以让开发者在主事件循环中执行后台或者低优先级的任务，而且不会对动画和用户的交互这些延迟触发但关键的事件产生影响，函数一般会按照先进先调用的顺序执行，除非函数在浏览器调用他之前就到了他的超出时间

## React中如何使用

> react中框架内部运作分为3层

- Virtual【van`chuo`wo】 Dom层， 描述页面
- Renconciler【rui `can `sha`le】层，负责调用组件的生命周期，进行Diff运算
- Renderer层，根据不同的平台，渲染出相应的页面，表现在ReactDom和ReactNative

**这次改动最大的就是Renconciler层，react的团队给他起了一个新名字，叫Fiber Renconciler**

**以前的Renconciler运行过程是不能被打断的，必须一条道走到黑**

**而现在的Fiber Renconciler每执行一段时间，就会将控制权交回浏览器，可以分段执行**

**为了达到这种效果，就需要有一个调度器（Scheduler【si`ke`ju`le】）来进行任务的分配，任务的优先级有六种**

- synchronous与之前的Renconciler操作一样，是同步执行
- task ，在next tick之前执行
- animation， 下一帧之前执行
- high，在不久的将来立即执行
- low，稍微延迟执行
- offscreen， 下一次render或者scroll时才执行

**优先级高的任务（如键盘输入）会打断优先级低的任务（如Diff）的执行，从而更快的生效**

> Fiber Renconciler在执行过程中，会分为两个阶段

- 阶段一： 生成Fiber树，得出需要更新的节点信息，这一步是一个渐进的过程，可以被打断

- 阶段二：将需要的更新的节点一次性批量更新，这个过程不能被打断

**阶段一被打断的特性，让优先级更高的任务先执行，从而大大减少了页面掉帧的概率**

## Fiber树

**Fiber Renconciler在阶段一进行Diff计算的时候，会生成一颗Filer树，这颗树是在Virtual Dom树的基础上增加额外的信息来源，他本质上是一个链表**

**Fiber 树在在首次的渲染的时候一次生成，在后续需要Diff的时候，会根据已有树和最新的Virtual DOM的信息，生成一颗新的树，这棵树每生成一个新的节点，都会将控制权交回给主线程，去检查有没有更高级的任务需要执行，如果没有，则继续构建树的过程**

**如果过程中有优先级更高的任务需要执行，则Fiber Renconciler会丢弃正在生成的树，在空闲的时候在重新执行一遍**

**在构建树的过程中，Fiber Renconciler会将需要更新的节点信息保存在Effect List当中，在阶段二执行的时候，会批量更新相应的节点**